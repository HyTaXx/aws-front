version: 1
backend:
    phases:
        preBuild:
            commands:
                - pip3 install --user pipenv
                - python3 --version
                - pip3 install --upgrade pip
                - pip3 install --user --upgrade setuptools wheel
                - amplifyPush --simple
        build:
            commands:
                - "# Execute Amplify CLI with the helper script"
                - amplifyPush --simple
frontend:
    phases:
        preBuild:
            commands:
                - nvm install 20.19.0
                - nvm use 20.19.0
                - npm ci --cache .npm --prefer-offline
                - npm run test:run || (echo "TEST_FAILED=true" >> $AMPLIFY_ENV && exit 1)
        build:
            commands:
                - npm run build
        postBuild:
            commands:
                - |
                    if [ "$TEST_FAILED" = "true" ] || [ "$AMPLIFY_BUILD_STATUS" = "FAILED" ]; then
                      echo "Tests failed or build failed, sending webhook notification..."
                      curl -X POST "https://hooks.zapier.com/hooks/catch/13687721/u27jgzq/" \
                        -H "Content-Type: application/json" \
                        -d '{
                          "message": "AWS Amplify build failed",
                          "repository": "'$AMPLIFY_APP_NAME'",
                          "branch": "'$AMPLIFY_BRANCH'",
                          "commit": "'$AMPLIFY_COMMIT_ID'",
                          "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)'",
                          "reason": "Tests or build failed"
                        }' || echo "Failed to send webhook notification"
                    fi
    artifacts:
        baseDirectory: dist
        files:
            - "**/*"
    cache:
        paths:
            - .npm/**/*
